"""
G√©n√©rateur de template Excel EBIOS RM conforme aux sp√©cifications.
Cr√©e l'onglet __REFS avec toutes les tables de r√©f√©rence et plages nomm√©es.
Applique les validations de donn√©es selon la m√©thodologie EBIOS RM.
"""

from pathlib import Path
from typing import Dict, List, Any
import logging

from openpyxl import Workbook
from openpyxl.worksheet.datavalidation import DataValidation
from openpyxl.worksheet.table import Table, TableStyleInfo
from openpyxl.styles import Font, PatternFill, Alignment, Protection
from openpyxl.workbook.defined_name import DefinedName
from openpyxl.worksheet.protection import SheetProtection
from openpyxl.utils import get_column_letter

logger = logging.getLogger(__name__)

class EBIOSTemplateGenerator:
    """G√©n√©rateur de template Excel EBIOS RM avec validation compl√®te."""
    
    def __init__(self):
        """Initialise le g√©n√©rateur avec les styles et donn√©es de r√©f√©rence."""
        self.wb = Workbook()
        # Styles pour le formatage
        self.gray_fill = PatternFill(start_color="D9D9D9", end_color="D9D9D9", fill_type="solid")
        self.header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        self.header_font = Font(bold=True, color="FFFFFF")
        
        # Donn√©es de r√©f√©rence EBIOS RM conformes
        self.reference_data = self._get_ebios_reference_data()
    
    def _get_ebios_reference_data(self) -> Dict[str, List[Dict[str, Any]]]:
        """D√©finit les donn√©es de r√©f√©rence EBIOS RM conformes √† la m√©thodologie."""
        return {
            # Table des niveaux de gravit√© (√©chelle 4 niveaux)
            "tbl_Gravite": [
                {"ID": 1, "Libelle": "N√©gligeable", "Valeur": 1},
                {"ID": 2, "Libelle": "Limit√©", "Valeur": 2},
                {"ID": 3, "Libelle": "Important", "Valeur": 3},
                {"ID": 4, "Libelle": "Critique", "Valeur": 4}
            ],
            
            # Table des niveaux de vraisemblance (√©chelle 4 niveaux)
            "tbl_Vraisemblance": [
                {"ID": 1, "Libelle": "Minimal", "Valeur": 1},
                {"ID": 2, "Libelle": "Significatif", "Valeur": 2},
                {"ID": 3, "Libelle": "√âlev√©", "Valeur": 3},
                {"ID": 4, "Libelle": "Maximal", "Valeur": 4}
            ],
            
            # **CORRECTION 1.3** : Ajouter les tables manquantes pour pertinence/exposition
            "tbl_Pertinence": [
                {"ID": 1, "Libelle": "Faible", "Valeur": 1},
                {"ID": 2, "Libelle": "Mod√©r√©e", "Valeur": 2},
                {"ID": 3, "Libelle": "Forte", "Valeur": 3}
            ],
            
            "tbl_Exposition": [
                {"ID": 1, "Libelle": "Limit√©e", "Valeur": 1},
                {"ID": 2, "Libelle": "Significative", "Valeur": 2},
                {"ID": 3, "Libelle": "Maximale", "Valeur": 3}
            ],
            
            # **CORRECTION 1** : Catalogue complet des mesures de s√©curit√© EBIOS RM
            "tbl_Measure": [
                {"Measure_ID": "M001", "Libelle": "Authentification multi-facteurs", "Category": "Acc√®s", "Type": "Pr√©ventif", "Score": 3},
                {"Measure_ID": "M002", "Libelle": "Chiffrement des donn√©es", "Category": "Donn√©es", "Type": "Pr√©ventif", "Score": 4},
                {"Measure_ID": "M003", "Libelle": "Supervision SOC", "Category": "Monitoring", "Type": "D√©tectif", "Score": 3},
                {"Measure_ID": "M004", "Libelle": "Sauvegarde externalis√©e", "Category": "Continuit√©", "Type": "R√©cup√©ration", "Score": 2},
                {"Measure_ID": "M005", "Libelle": "Formation sensibilisation", "Category": "Humain", "Type": "Pr√©ventif", "Score": 2},
                {"Measure_ID": "M006", "Libelle": "Pare-feu applicatif", "Category": "R√©seau", "Type": "Pr√©ventif", "Score": 3},
                {"Measure_ID": "M007", "Libelle": "Plan de continuit√©", "Category": "Continuit√©", "Type": "R√©cup√©ration", "Score": 4},
                {"Measure_ID": "M008", "Libelle": "Audit de s√©curit√©", "Category": "Gouvernance", "Type": "D√©tectif", "Score": 2},
                {"Measure_ID": "M009", "Libelle": "Contr√¥le d'acc√®s physique", "Category": "Physique", "Type": "Pr√©ventif", "Score": 3},
                {"Measure_ID": "M010", "Libelle": "Gestion des correctifs", "Category": "Syst√®mes", "Type": "Pr√©ventif", "Score": 4}
            ],
            
            # **NOUVELLE EXTENSION** : Catalogue complet des mesures ISO 27001 Annex A 2022
            "tbl_Measure": [
                {"Measure_ID": "A.5.1", "Libelle": "Politiques de s√©curit√© de l'information", "Category": "Organisationnelles", "Cout": 2, "Efficacite_pct": 80, "AnnexA_Control": "A.5.1"},
                {"Measure_ID": "A.5.2", "Libelle": "R√¥les et responsabilit√©s en mati√®re de s√©curit√©", "Category": "Organisationnelles", "Cout": 1, "Efficacite_pct": 70, "AnnexA_Control": "A.5.2"},
                {"Measure_ID": "A.5.3", "Libelle": "S√©paration des t√¢ches", "Category": "Organisationnelles", "Cout": 2, "Efficacite_pct": 85, "AnnexA_Control": "A.5.3"},
                {"Measure_ID": "A.6.1", "Libelle": "Criblage des ant√©c√©dents", "Category": "Personnel", "Cout": 2, "Efficacite_pct": 75, "AnnexA_Control": "A.6.1"},
                {"Measure_ID": "A.6.2", "Libelle": "Termes et conditions d'emploi", "Category": "Personnel", "Cout": 1, "Efficacite_pct": 60, "AnnexA_Control": "A.6.2"},
                {"Measure_ID": "A.6.3", "Libelle": "Sensibilisation et formation √† la s√©curit√©", "Category": "Personnel", "Cout": 3, "Efficacite_pct": 90, "AnnexA_Control": "A.6.3"},
                {"Measure_ID": "A.6.4", "Libelle": "Processus disciplinaire", "Category": "Personnel", "Cout": 1, "Efficacite_pct": 65, "AnnexA_Control": "A.6.4"},
                {"Measure_ID": "A.7.1", "Libelle": "S√©curit√© physique des zones", "Category": "Physiques", "Cout": 4, "Efficacite_pct": 95, "AnnexA_Control": "A.7.1"},
                {"Measure_ID": "A.7.2", "Libelle": "Contr√¥les physiques d'entr√©e", "Category": "Physiques", "Cout": 3, "Efficacite_pct": 90, "AnnexA_Control": "A.7.2"},
                {"Measure_ID": "A.7.3", "Libelle": "Protection contre les menaces environnementales", "Category": "Physiques", "Cout": 4, "Efficacite_pct": 85, "AnnexA_Control": "A.7.3"},
                {"Measure_ID": "A.8.1", "Libelle": "Gestion des actifs", "Category": "Techniques", "Cout": 2, "Efficacite_pct": 80, "AnnexA_Control": "A.8.1"},
                {"Measure_ID": "A.8.2", "Libelle": "Classification de l'information", "Category": "Techniques", "Cout": 2, "Efficacite_pct": 85, "AnnexA_Control": "A.8.2"},
                {"Measure_ID": "A.8.3", "Libelle": "Manipulation des supports", "Category": "Techniques", "Cout": 2, "Efficacite_pct": 75, "AnnexA_Control": "A.8.3"},
                {"Measure_ID": "A.9.1", "Libelle": "Contr√¥le d'acc√®s", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 95, "AnnexA_Control": "A.9.1"},
                {"Measure_ID": "A.9.2", "Libelle": "Gestion des acc√®s utilisateur", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 90, "AnnexA_Control": "A.9.2"},
                {"Measure_ID": "A.9.3", "Libelle": "Gestion des acc√®s privil√©gi√©s", "Category": "Techniques", "Cout": 4, "Efficacite_pct": 95, "AnnexA_Control": "A.9.3"},
                {"Measure_ID": "A.9.4", "Libelle": "Gestion des informations d'authentification secr√®tes", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 90, "AnnexA_Control": "A.9.4"},
                {"Measure_ID": "A.10.1", "Libelle": "Chiffrement", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 95, "AnnexA_Control": "A.10.1"},
                {"Measure_ID": "A.10.2", "Libelle": "Gestion des cl√©s cryptographiques", "Category": "Techniques", "Cout": 4, "Efficacite_pct": 90, "AnnexA_Control": "A.10.2"},
                {"Measure_ID": "A.11.1", "Libelle": "Sauvegarde des informations", "Category": "Techniques", "Cout": 2, "Efficacite_pct": 85, "AnnexA_Control": "A.11.1"},
                {"Measure_ID": "A.11.2", "Libelle": "Redondance des √©quipements de traitement", "Category": "Techniques", "Cout": 4, "Efficacite_pct": 90, "AnnexA_Control": "A.11.2"},
                {"Measure_ID": "A.12.1", "Libelle": "S√©curit√© des r√©seaux", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 90, "AnnexA_Control": "A.12.1"},
                {"Measure_ID": "A.12.2", "Libelle": "S√©paration des r√©seaux", "Category": "Techniques", "Cout": 3, "Efficacite_pct": 85, "AnnexA_Control": "A.12.2"},
                {"Measure_ID": "A.13.1", "Libelle": "Gestion de la s√©curit√© des applications", "Category": "Techniques", "Cout": 4, "Efficacite_pct": 85, "AnnexA_Control": "A.13.1"},
                {"Measure_ID": "A.13.2", "Libelle": "D√©veloppement s√©curis√©", "Category": "Techniques", "Cout": 4, "Efficacite_pct": 90, "AnnexA_Control": "A.13.2"},
                {"Measure_ID": "A.14.1", "Libelle": "Gestion des incidents de s√©curit√©", "Category": "Organisationnelles", "Cout": 3, "Efficacite_pct": 85, "AnnexA_Control": "A.14.1"},
                {"Measure_ID": "A.14.2", "Libelle": "Apprentissage des incidents", "Category": "Organisationnelles", "Cout": 2, "Efficacite_pct": 75, "AnnexA_Control": "A.14.2"},
                {"Measure_ID": "A.15.1", "Libelle": "Continuit√© de la s√©curit√©", "Category": "Organisationnelles", "Cout": 4, "Efficacite_pct": 90, "AnnexA_Control": "A.15.1"},
                {"Measure_ID": "A.15.2", "Libelle": "Redondances", "Category": "Organisationnelles", "Cout": 4, "Efficacite_pct": 85, "AnnexA_Control": "A.15.2"},
                {"Measure_ID": "A.16.1", "Libelle": "Conformit√© r√©glementaire", "Category": "Juridiques", "Cout": 3, "Efficacite_pct": 80, "AnnexA_Control": "A.16.1"},
                {"Measure_ID": "A.16.2", "Libelle": "Audits de s√©curit√©", "Category": "Juridiques", "Cout": 3, "Efficacite_pct": 85, "AnnexA_Control": "A.16.2"}
            ],
            
            # **NOUVELLE EXTENSION** : Table des sous-types d'actifs pour listes d√©pendantes
            "tbl_AssetSubtype": [
                {"Asset_Type_ID": "AT001", "Subtype": "Serveur Web", "Description": "Serveur h√©bergeant applications web"},
                {"Asset_Type_ID": "AT001", "Subtype": "Serveur Base", "Description": "Serveur de base de donn√©es"},
                {"Asset_Type_ID": "AT001", "Subtype": "Serveur Mail", "Description": "Serveur de messagerie"},
                {"Asset_Type_ID": "AT002", "Subtype": "MySQL", "Description": "Base MySQL"},
                {"Asset_Type_ID": "AT002", "Subtype": "PostgreSQL", "Description": "Base PostgreSQL"},
                {"Asset_Type_ID": "AT002", "Subtype": "Oracle", "Description": "Base Oracle"},
                {"Asset_Type_ID": "AT003", "Subtype": "Web App", "Description": "Application web"},
                {"Asset_Type_ID": "AT003", "Subtype": "Mobile App", "Description": "Application mobile"},
                {"Asset_Type_ID": "AT003", "Subtype": "Desktop App", "Description": "Application bureautique"},
                {"Asset_Type_ID": "AT006", "Subtype": "Donn√©es clients", "Description": "Informations clients"},
                {"Asset_Type_ID": "AT006", "Subtype": "Donn√©es RH", "Description": "Informations ressources humaines"},
                {"Asset_Type_ID": "AT006", "Subtype": "Donn√©es financi√®res", "Description": "Informations financi√®res"}
            ],
            
            # **NOUVELLE EXTENSION** : Table des KPI de maturit√©
            "tbl_KPI": [
                {"KPI_ID": "VEL001", "Libelle": "Velocity Detection", "Category": "Velocity", "Target": 24, "Unit": "heures", "Formula": "Temps moyen d√©tection incident"},
                {"KPI_ID": "VEL002", "Libelle": "Velocity Response", "Category": "Velocity", "Target": 4, "Unit": "heures", "Formula": "Temps moyen r√©ponse incident"},
                {"KPI_ID": "PREP001", "Libelle": "Preparedness Coverage", "Category": "Preparedness", "Target": 95, "Unit": "%", "Formula": "% actifs couverts par mesures"},
                {"KPI_ID": "PREP002", "Libelle": "Preparedness Training", "Category": "Preparedness", "Target": 90, "Unit": "%", "Formula": "% personnel form√©"},
                {"KPI_ID": "MAT001", "Libelle": "Maturity Overall", "Category": "Maturity", "Target": 3, "Unit": "niveau", "Formula": "Niveau maturit√© global (1-5)"}
            ],
            
            # Catalogue des sources de risque EBIOS RM
            "tbl_Source": [
                {
                    "Source_ID": "RS001",
                    "Label": "Cybercriminels organis√©s",
                    "Category": "Criminalit√© organis√©e",
                    "MotivationResources": "Gain financier - Outils avanc√©s",
                    "Targeting": "Donn√©es sensibles et syst√®mes de paiement"
                },
                {
                    "Source_ID": "RS002", 
                    "Label": "Acteurs √©tatiques",
                    "Category": "Espionnage d'√âtat",
                    "MotivationResources": "Intelligence √©conomique - Ressources illimit√©es",
                    "Targeting": "Informations strat√©giques et propri√©t√© intellectuelle"
                },
                {
                    "Source_ID": "RS003",
                    "Label": "Employ√©s malveillants", 
                    "Category": "Menace interne",
                    "MotivationResources": "Vengeance ou gain personnel - Acc√®s privil√©gi√©",
                    "Targeting": "Donn√©es confidentielles et syst√®mes internes"
                },
                {
                    "Source_ID": "RS004",
                    "Label": "Hacktivistes",
                    "Category": "Activisme num√©rique",
                    "MotivationResources": "Id√©ologie - Outils collaboratifs",
                    "Targeting": "Sites web et communication publique"
                },
                {
                    "Source_ID": "RS005",
                    "Label": "Prestataires compromis",
                    "Category": "Cha√Æne d'approvisionnement",
                    "MotivationResources": "Acc√®s indirect - Privil√®ges √©tendus",
                    "Targeting": "Syst√®mes clients via relations de confiance"
                }
            ],
            
            # Catalogue des sc√©narios strat√©giques
            "tbl_Scenario": [
                {
                    "Scenario_ID": "SR001",
                    "Risk_Source": "RS001",
                    "Target_Objective": "Vol de donn√©es clients",
                    "Attack_Path": "Attaque externe cibl√©e",
                    "Motivation": "Revente de donn√©es personnelles"
                },
                {
                    "Scenario_ID": "SR002",
                    "Risk_Source": "RS003", 
                    "Target_Objective": "Sabotage syst√®me",
                    "Attack_Path": "Abus de privil√®ges internes",
                    "Motivation": "Vengeance apr√®s licenciement"
                },
                {
                    "Scenario_ID": "SR003",
                    "Risk_Source": "RS002",
                    "Target_Objective": "Espionnage industriel",
                    "Attack_Path": "APT cibl√©e longue dur√©e",
                    "Motivation": "Avantage concurrentiel √©tatique"
                },
                {
                    "Scenario_ID": "SR004",
                    "Risk_Source": "RS004",
                    "Target_Objective": "D√©figuration site web",
                    "Attack_Path": "Attaque de surface publique",
                    "Motivation": "Message politique ou social"
                }
            ],
            
            # Catalogue des sc√©narios op√©rationnels (OV)
            "tbl_OV": [
                {
                    "OV_ID": "OV001",
                    "Strategic_Scenario": "SR001",
                    "Attack_Vector": "Phishing et ing√©nierie sociale",
                    "Operational_Steps": "Reconnaissance > Intrusion > Persistance > Exfiltration"
                },
                {
                    "OV_ID": "OV002",
                    "Strategic_Scenario": "SR002",
                    "Attack_Vector": "Acc√®s physique et logique",
                    "Operational_Steps": "Planification > Ex√©cution > Effacement traces"
                },
                {
                    "OV_ID": "OV003",
                    "Strategic_Scenario": "SR003",
                    "Attack_Vector": "Compromission cha√Æne logicielle",
                    "Operational_Steps": "Infiltration > Installation > C&C > Collecte > Exfiltration"
                },
                {
                    "OV_ID": "OV004",
                    "Strategic_Scenario": "SR004",
                    "Attack_Vector": "Exploitation vuln√©rabilit√©s web",
                    "Operational_Steps": "Scan > Exploitation > D√©figuration > Revendication"
                }
            ],
            
            # Table des types d'actifs avec libell√©s complets
            "tbl_AssetType": [
                {"Asset_Type_ID": "AT001", "Libelle": "Serveur", "Description": "Serveurs physiques et virtuels"},
                {"Asset_Type_ID": "AT002", "Libelle": "Base de donn√©es", "Description": "Syst√®mes de gestion de base de donn√©es"},
                {"Asset_Type_ID": "AT003", "Libelle": "Application", "Description": "Applications m√©tier et logiciels"},
                {"Asset_Type_ID": "AT004", "Libelle": "R√©seau", "Description": "Infrastructure r√©seau et t√©l√©coms"},
                {"Asset_Type_ID": "AT005", "Libelle": "Poste de travail", "Description": "Postes utilisateurs et p√©riph√©riques"},
                {"Asset_Type_ID": "AT006", "Libelle": "Donn√©es", "Description": "Donn√©es et informations sensibles"},
                {"Asset_Type_ID": "AT007", "Libelle": "Personnel", "Description": "Ressources humaines et comp√©tences"},
                {"Asset_Type_ID": "AT008", "Libelle": "Locaux", "Description": "Sites et infrastructures physiques"},
                {"Asset_Type_ID": "AT009", "Libelle": "Processus", "Description": "Processus m√©tier et proc√©dures"}
            ],
            
            # Table des parties prenantes avec libell√©s complets
            "tbl_Stakeholder": [
                {"Stakeholder_ID": "SH001", "Libelle": "DSI", "Description": "Direction des Syst√®mes d'Information"},
                {"Stakeholder_ID": "SH002", "Libelle": "Direction", "Description": "Direction G√©n√©rale"},
                {"Stakeholder_ID": "SH003", "Libelle": "RSSI", "Description": "Responsable S√©curit√© des Syst√®mes d'Information"},
                {"Stakeholder_ID": "SH004", "Libelle": "DPO", "Description": "D√©l√©gu√© √† la Protection des Donn√©es"},
                {"Stakeholder_ID": "SH005", "Libelle": "M√©tier", "Description": "Directions m√©tier"},
                {"Stakeholder_ID": "SH006", "Libelle": "Support", "Description": "Support technique et maintenance"},
                {"Stakeholder_ID": "SH007", "Libelle": "Externe", "Description": "Prestataires externes"},
                {"Stakeholder_ID": "SH008", "Libelle": "Fournisseur", "Description": "Fournisseurs et partenaires"}
            ]
        }

    def generate_template(self, output_path: Path, pme_profile: bool = False) -> None:
        """G√©n√®re le template Excel complet conforme EBIOS RM."""
        logger.info("G√©n√©ration du template Excel EBIOS RM...")
        
        if pme_profile:
            logger.info("Mode PME/TPE activ√© - Configuration simplifi√©e")
        
        # Supprimer la feuille par d√©faut
        if "Sheet" in self.wb.sheetnames:
            self.wb.remove(self.wb["Sheet"])
        
        # 1. Cr√©er l'onglet de r√©f√©rences avec toutes les tables
        self._create_references_sheet()
        
        # 2. Cr√©er l'onglet de configuration EBIOS RM
        self._create_config_sheet(pme_profile)
        
        # 3. Cr√©er les onglets de travail EBIOS RM complets
        self._create_atelier1_socle()
        self._create_atelier2_sources()
        self._create_atelier3_scenarios() 
        self._create_atelier4_operationnels()
        self._create_atelier5_traitement()  # **CORRECTION 1** : Ajout du 5√®me atelier
        self._create_synthese()
        
        # 4. Configuration finale
        self.wb["__REFS"].sheet_state = "veryHidden"  # Masquer l'onglet r√©f√©rences
        self.wb.active = self.wb["Config_EBIOS"]    # D√©finir la feuille de config comme active
        
        # 5. Sauvegarder le classeur
        self.wb.save(output_path)
        logger.info(f"Template g√©n√©r√© avec succ√®s : {output_path}")

    def _create_references_sheet(self) -> None:
        """Cr√©e l'onglet __REFS avec toutes les tables de r√©f√©rence et plages nomm√©es."""
        ws = self.wb.create_sheet("__REFS")
        
        current_col = 1  # Position de d√©part pour les tables
        
        # Cr√©er chaque table de r√©f√©rence
        for table_name, data in self.reference_data.items():
            if not data:
                continue
                
            # Extraire les en-t√™tes de la premi√®re ligne de donn√©es
            headers = list(data[0].keys())
            start_row = 1
            start_col = current_col
            
            # √âcrire les en-t√™tes avec style
            for i, header in enumerate(headers):
                cell = ws.cell(row=start_row, column=start_col + i, value=header)
                cell.font = self.header_font
                cell.fill = self.header_fill
                cell.alignment = Alignment(horizontal="center")
            
            # √âcrire les donn√©es de r√©f√©rence
            for row_idx, row_data in enumerate(data, start=2):
                for col_idx, (key, value) in enumerate(row_data.items()):
                    ws.cell(row=row_idx, column=start_col + col_idx, value=value)
            
            # Cr√©er la table Excel pour cette r√©f√©rence
            end_row = len(data) + 1
            end_col = start_col + len(headers) - 1
            table_ref = f"{get_column_letter(start_col)}{start_row}:{get_column_letter(end_col)}{end_row}"
            
            table = Table(displayName=table_name, ref=table_ref)
            table.tableStyleInfo = TableStyleInfo(
                name="TableStyleMedium2", 
                showFirstColumn=False,
                showRowStripes=True
            )
            ws.add_table(table)
            
            # Cr√©er les plages nomm√©es pour les validations
            self._create_named_ranges_for_table(ws, table_name, headers, start_col, start_row, end_row)
            
            # Passer √† la position suivante (avec espacement)
            current_col = end_col + 2
        
        # **CORRECTION 1.1** : Ajouter les plages pour Pertinence/Exposition
        pertinence_range = f"__REFS!$A$2:$A$4"  # Ajuster selon position r√©elle
        exposition_range = f"__REFS!$A$2:$A$4"   # Ajuster selon position r√©elle
        
        self.wb.defined_names["Pertinence"] = DefinedName("Pertinence", attr_text=pertinence_range)
        self.wb.defined_names["Exposition"] = DefinedName("Exposition", attr_text=exposition_range)

    def _create_named_ranges_for_table(self, ws, table_name: str, headers: List[str], 
                                      start_col: int, start_row: int, end_row: int) -> None:
        """Cr√©e les plages nomm√©es n√©cessaires pour les validations et formules XLOOKUP."""
        
        # **CORRECTION 2** : Mapping complet avec toutes les plages requises
        range_mappings = {
            "tbl_Gravite": {"Libelle": "Gravite", "ID": "tbl_Gravite_ID", "Valeur": "tbl_Gravite_Valeur"},
            "tbl_Vraisemblance": {"Libelle": "Vraisemblance", "ID": "tbl_Vraisemblance_ID", "Valeur": "tbl_Vraisemblance_Valeur"}, 
            "tbl_ValeurMetier": {"ID": "Valeur_Metier", "Libelle": "tbl_ValeurMetier_ID", "Valeur": "tbl_ValeurMetier_Valeur"},
            "tbl_Pertinence": {"Libelle": "Pertinence", "ID": "tbl_Pertinence_ID", "Valeur": "tbl_Pertinence_Valeur"},
            "tbl_Exposition": {"Libelle": "Exposition", "ID": "tbl_Exposition_ID", "Valeur": "tbl_Exposition_Valeur"},
            "tbl_Measure": {"Measure_ID": "Measure_ID", "Libelle": "tbl_Measure_Label"},
            "tbl_Source": {"Source_ID": "Source_ID"},
            "tbl_Scenario": {"Scenario_ID": "Scenario_ID"},
            "tbl_OV": {"OV_ID": "OV_ID"},
            "tbl_AssetType": {"Asset_Type_ID": "Asset_Type", "Libelle": "tbl_AssetType_Label"},
            "tbl_Stakeholder": {"Stakeholder_ID": "Stakeholder_ID", "Libelle": "tbl_Stakeholder_Label"}
        }
        
        # Cr√©er les plages nomm√©es principales avec v√©rification
        if table_name in range_mappings:
            for header_name, range_name in range_mappings[table_name].items():
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    
                    # V√©rifier que la plage est valide
                    if end_row > start_row:
                        range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                        defined_name = DefinedName(range_name, attr_text=range_ref)
                        
                        # Ajouter la plage nomm√©e au classeur
                        self.wb.defined_names[range_name] = defined_name
                        logger.info(f"Plage nomm√©e cr√©√©e: {range_name} = {range_ref}")
        
        # Cr√©er des plages nomm√©es d√©taill√©es pour XLOOKUP avec tables compl√®tes
        detailed_mappings = {
            "tbl_Source": ["Source_ID", "Label", "Category", "MotivationResources", "Targeting"],
            "tbl_Scenario": ["Scenario_ID", "Risk_Source", "Target_Objective", "Attack_Path", "Motivation"],
            "tbl_OV": ["OV_ID", "Strategic_Scenario", "Attack_Vector", "Operational_Steps"]
        }
        
        if table_name in detailed_mappings:
            # Cr√©er une plage pour toute la table pour XLOOKUP
            table_start_col = get_column_letter(start_col)
            table_end_col = get_column_letter(start_col + len(headers) - 1)
            table_range = f"__REFS!${table_start_col}$2:${table_end_col}${end_row}"
            table_range_name = f"{table_name}_Table"
            
            defined_name = DefinedName(table_range_name, attr_text=table_range)
            self.wb.defined_names[table_range_name] = defined_name
            logger.info(f"Table compl√®te cr√©√©e: {table_range_name} = {table_range}")
            
            # Cr√©er des plages individuelles pour chaque colonne
            for header_name in detailed_mappings[table_name]:
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    
                    range_name = f"{table_name}_{header_name}"
                    
                    if end_row > start_row:
                        range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                        defined_name = DefinedName(range_name, attr_text=range_ref)
                        
                        self.wb.defined_names[range_name] = defined_name
                        logger.info(f"Plage d√©taill√©e cr√©√©e: {range_name} = {range_ref}")
        
        # **CORRECTION 1.1** : Ajouter toutes les plages num√©riques pour calculs avanc√©s
        if table_name == "tbl_Gravite":
            for header_name in ["ID", "Libelle", "Valeur"]:
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                    
                    if header_name == "Libelle":
                        self.wb.defined_names["Gravity_Labels"] = DefinedName("Gravity_Labels", attr_text=range_ref)
        
        if table_name == "tbl_Vraisemblance":
            for header_name in ["ID", "Libelle", "Valeur"]:
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                    
                    if header_name == "Libelle":
                        self.wb.defined_names["Likelihood_Labels"] = DefinedName("Likelihood_Labels", attr_text=range_ref)
        
        if table_name == "tbl_ValeurMetier":
            for header_name in ["ID", "Libelle", "Valeur"]:
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                    
                    if header_name == "Libelle":
                        self.wb.defined_names["BusinessValue_Labels"] = DefinedName("BusinessValue_Labels", attr_text=range_ref)
        
        # **CORRECTION 1** : Plages pour les nouvelles tables
        if table_name == "tbl_Measure":
            for header_name in ["Measure_ID", "Libelle"]:
                if header_name in headers:
                    col_idx = headers.index(header_name)
                    col_letter = get_column_letter(start_col + col_idx)
                    range_ref = f"__REFS!${col_letter}$2:${col_letter}${end_row}"
                    
                    range_name = "Measure_ID" if header_name == "Measure_ID" else "tbl_Measure_Label"
                    self.wb.defined_names[range_name] = DefinedName(range_name, attr_text=range_ref)

    def _create_atelier1_socle(self) -> None:
        """Cr√©e l'Atelier 1 - Socle avec les validations appropri√©es et formule de risque pond√©r√©e."""
        ws = self.wb.create_sheet("Atelier1_Socle")
        
        # En-t√™tes fran√ßais selon EBIOS RM Atelier 1
        headers = [
            "ID_Actif", "Type", "Libell√©", "Description", "Gravit√©",
            "Confidentialit√©", "Int√©grit√©", "Disponibilit√©", 
            "Valeur_M√©tier", "Propri√©taire", "Score_Risque"
        ]
        
        # Cr√©er les en-t√™tes avec style
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # Appliquer les validations de donn√©es selon EBIOS RM
        validations_config = {
            2: "Asset_Type",        # Colonne Type
            5: "Gravite",           # Colonne Gravit√©
            6: "Gravite",           # Colonne Confidentialit√©  
            7: "Gravite",           # Colonne Int√©grit√©
            8: "Gravite",           # Colonne Disponibilit√©
            9: "Valeur_Metier",     # Colonne Valeur M√©tier
            10: "Stakeholder_ID",   # Colonne Propri√©taire
        }
        
        # Appliquer chaque validation avec le signe "=" obligatoire
        for col_num, range_name in validations_config.items():
            dv = DataValidation(type="list", formula1=f"={range_name}", allow_blank=True)
            ws.add_data_validation(dv)
            dv.add(f"{get_column_letter(col_num)}2:{get_column_letter(col_num)}100")
        
        # **CORRECTION 3** : Formule de risque pond√©r√©e corrig√©e avec XLOOKUP
        for row in range(2, 101):
            risk_formula = f"""=IF(AND(E{row}<>"",F{row}<>"",G{row}<>"",H{row}<>"",I{row}<>""),
XLOOKUP(E{row},Gravite,tbl_Gravite_ID)*
XLOOKUP(F{row},Gravite,tbl_Gravite_ID)*
XLOOKUP(G{row},Gravite,tbl_Gravite_ID)*
XLOOKUP(H{row},Gravite,tbl_Gravite_ID)*
XLOOKUP(I{row},Valeur_Metier,tbl_ValeurMetier_ID),"")"""
            
            cell = ws.cell(row=row, column=11, value=risk_formula)
            self._format_formula_cell(cell)
        
        # Ajouter des exemples de donn√©es
        sample_data = [
            ["A001", "", "Base clients", "Base de donn√©es des clients", "", "", "", "", "", "", ""],
            ["A002", "", "Serveur web", "Serveur d'application web", "", "", "", "", "", "", ""],
            ["A003", "", "Plans strat√©giques", "Documents confidentiels", "", "", "", "", "", "", ""],
        ]
        
        for row_idx, row_data in enumerate(sample_data, 2):
            for col_idx, value in enumerate(row_data, 1):
                if col_idx != 11:  # Ne pas √©craser la formule de score
                    ws.cell(row=row_idx, column=col_idx, value=value)
        
        # Appliquer la protection et le formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"  # Figer les volets

    def _create_atelier2_sources(self) -> None:
        """Cr√©e l'Atelier 2 - Sources de risque avec formules XLOOKUP fonctionnelles."""
        ws = self.wb.create_sheet("Atelier2_Sources") 
        
        # En-t√™tes fran√ßais selon EBIOS RM Atelier 2
        headers = [
            "ID_Source", "Libell√©", "Cat√©gorie", "Motivation_Ressources", 
            "Ciblage", "Pertinence", "Exposition", "Commentaires"
        ]
        
        # Cr√©er les en-t√™tes
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # Validation ID_Source avec plage nomm√©e
        dv = DataValidation(type="list", formula1="=Source_ID", allow_blank=True)
        ws.add_data_validation(dv)
        dv.add("A2:A1000")
        
        # Formules XLOOKUP corrig√©es pour recherche dans toute la table
        for row in range(2, 101):
            # Libell√© - recherche dans la table compl√®te
            cell = ws.cell(row=row, column=2, value=f"=IFERROR(INDEX(tbl_Source_Label,MATCH(A{row},tbl_Source_Source_ID,0)),\"\")")
            self._format_formula_cell(cell)
            
            # Cat√©gorie
            cell = ws.cell(row=row, column=3, value=f"=IFERROR(INDEX(tbl_Source_Category,MATCH(A{row},tbl_Source_Source_ID,0)),\"\")")
            self._format_formula_cell(cell)
            
            # Motivation_Ressources
            cell = ws.cell(row=row, column=4, value=f"=IFERROR(INDEX(tbl_Source_MotivationResources,MATCH(A{row},tbl_Source_Source_ID,0)),\"\")")
            self._format_formula_cell(cell)
            
            # Ciblage
            cell = ws.cell(row=row, column=5, value=f"=IFERROR(INDEX(tbl_Source_Targeting,MATCH(A{row},tbl_Source_Source_ID,0)),\"\")")
            self._format_formula_cell(cell)
        
        # Validations pour les niveaux d'√©valuation
        for col in [6, 7]:  # Pertinence, Exposition
            dv = DataValidation(type="list", formula1="=Gravite", allow_blank=True)
            ws.add_data_validation(dv)
            dv.add(f"{get_column_letter(col)}2:{get_column_letter(col)}1000")
        
        # **CORRECTION 2** : Validations corrig√©es pour Pertinence/Exposition
        pertinence_dv = DataValidation(type="list", formula1="=Pertinence", allow_blank=True)
        ws.add_data_validation(pertinence_dv)
        pertinence_dv.add("F2:F1000")
        
        exposition_dv = DataValidation(type="list", formula1="=Exposition", allow_blank=True)
        ws.add_data_validation(exposition_dv)
        exposition_dv.add("G2:G1000")
        
        # Protection et formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"

    def _create_atelier3_scenarios(self) -> None:
        """Cr√©e l'Atelier 3 - Sc√©narios strat√©giques avec formules XLOOKUP et calcul de risque pond√©r√©."""
        ws = self.wb.create_sheet("Atelier3_Scenarios")
        
        # En-t√™tes fran√ßais selon EBIOS RM Atelier 3
        headers = [
            "ID_Sc√©nario", "Source_Risque", "Objectif_Vis√©", "Chemin_Attaque",
            "Motivation", "Gravit√©", "Vraisemblance", "Valeur_M√©tier", "Risque_Calcul√©"
        ]
        
        # Cr√©er les en-t√™tes
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # Validation ID_Sc√©nario
        dv = DataValidation(type="list", formula1="=Scenario_ID", allow_blank=True)
        ws.add_data_validation(dv)
        dv.add("A2:A1000")
        
        # Formules RECHERCHEX pour remplissage automatique
        for row in range(2, 101):
            # Source_Risque - formule XLOOKUP corrig√©e
            cell = ws.cell(row=row, column=2, value=f"=IFERROR(XLOOKUP(A{row},tbl_Scenario_Scenario_ID,tbl_Scenario_Risk_Source),\"\")")
            self._format_formula_cell(cell)
            
            # Objectif_Vis√©
            cell = ws.cell(row=row, column=3, value=f"=IFERROR(XLOOKUP(A{row},tbl_Scenario_Scenario_ID,tbl_Scenario_Target_Objective),\"\")")
            self._format_formula_cell(cell)
            
            # Chemin_Attaque
            cell = ws.cell(row=row, column=4, value=f"=IFERROR(XLOOKUP(A{row},tbl_Scenario_Scenario_ID,tbl_Scenario_Attack_Path),\"\")")
            self._format_formula_cell(cell)
            
            # Motivation
            cell = ws.cell(row=row, column=5, value=f"=IFERROR(XLOOKUP(A{row},tbl_Scenario_Scenario_ID,tbl_Scenario_Motivation),\"\")")
            self._format_formula_cell(cell)
            
            # **CORRECTION 3** : Calcul du risque pond√©r√© avec XLOOKUP
            risk_formula = f"""=IF(AND(F{row}<>"",G{row}<>"",H{row}<>""),
XLOOKUP(F{row},Gravite,tbl_Gravite_ID)*
XLOOKUP(G{row},Vraisemblance,tbl_Vraisemblance_ID)*
XLOOKUP(H{row},Valeur_Metier,tbl_ValeurMetier_ID),"")"""
            
            cell = ws.cell(row=row, column=9, value=risk_formula)
            self._format_formula_cell(cell)
        
        # Validations pour l'√©valuation manuelle
        validation_config = {
            6: "Gravite",           # Gravit√©
            7: "Vraisemblance",     # Vraisemblance
            8: "Valeur_Metier"      # Valeur M√©tier
        }
        
        for col, range_name in validation_config.items():
            dv = DataValidation(type="list", formula1=f"={range_name}", allow_blank=True)
            ws.add_data_validation(dv)
            dv.add(f"{get_column_letter(col)}2:{get_column_letter(col)}1000")
        
        # Protection et formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"

    def _create_atelier4_operationnels(self) -> None:
        """Cr√©e l'Atelier 4 - Sc√©narios op√©rationnels avec calculs automatiques."""
        ws = self.wb.create_sheet("Atelier4_Operationnels")
        
        # **CORRECTION 1** : En-t√™tes √©tendus avec mesures de s√©curit√©
        headers = [
            "ID_OV", "Sc√©nario_Strat√©gique", "Vecteur_Attaque", "√âtapes_Op√©rationnelles",
            "Contr√¥les_Existants", "Vraisemblance_R√©siduelle", "Impact", "Mesure_Recommand√©e", 
            "Efficacit√©_Mesure", "Vraisemblance_Finale", "Niveau_Risque"
        ]
        
        # Cr√©er les en-t√™tes
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # Validation ID_OV
        dv = DataValidation(type="list", formula1="=OV_ID", allow_blank=True)
        ws.add_data_validation(dv)
        dv.add("A2:A1000")
        
        # **CORRECTION 3** : Formules XLOOKUP pour remplissage automatique
        for row in range(2, 101):
            # Sc√©nario_Strat√©gique - formule XLOOKUP corrig√©e
            cell = ws.cell(row=row, column=2, value=f"=IFERROR(XLOOKUP(A{row},tbl_OV_OV_ID,tbl_OV_Strategic_Scenario),\"\")")
            self._format_formula_cell(cell)
            
            # Vecteur_Attaque
            cell = ws.cell(row=row, column=3, value=f"=IFERROR(XLOOKUP(A{row},tbl_OV_OV_ID,tbl_OV_Attack_Vector),\"\")")
            self._format_formula_cell(cell)
            
            # √âtapes_Op√©rationnelles
            cell = ws.cell(row=row, column=4, value=f"=IFERROR(XLOOKUP(A{row},tbl_OV_OV_ID,tbl_OV_Operational_Steps),\"\")")
            self._format_formula_cell(cell)
            
            # **CORRECTION 1** : Libell√© de la mesure recommand√©e
            cell = ws.cell(row=row, column=8, value=f"=IFERROR(XLOOKUP(H{row},Measure_ID,tbl_Measure_Label),\"\")")
            self._format_formula_cell(cell)
            
            # **CORRECTION 3** : Calcul de vraisemblance finale pond√©r√©e par efficacit√© mesure
            vraisemblance_finale_formula = f"""=IF(AND(F{row}<>"",I{row}<>""),
MAX(1,XLOOKUP(F{row},Vraisemblance,tbl_Vraisemblance_ID)-XLOOKUP(I{row},Gravite,tbl_Gravite_ID)+1),"")"""
            
            cell = ws.cell(row=row, column=10, value=vraisemblance_finale_formula)
            self._format_formula_cell(cell)
            
            # **CORRECTION 3** : Calcul automatique du niveau de risque final
            risk_formula = f"""=IF(AND(J{row}<>"",G{row}<>""),
IF(AND(J{row}>=3,XLOOKUP(G{row},Gravite,tbl_Gravite_ID)>=3),"Critique",
IF(OR(J{row}>=3,XLOOKUP(G{row},Gravite,tbl_Gravite_ID)>=3),"√âlev√©",
IF(AND(J{row}>=2,XLOOKUP(G{row},Gravite,tbl_Gravite_ID)>=2),"Moyen","Faible"))),"")"""
            
            cell = ws.cell(row=row, column=11, value=risk_formula)
            self._format_formula_cell(cell)
        
        # **CORRECTION 2** : Validations √©tendues pour toutes les colonnes
        validation_config = {
            6: "Vraisemblance",     # Vraisemblance r√©siduelle
            7: "Gravite",           # Impact
            8: "Measure_ID",        # Mesure recommand√©e
            9: "Gravite"            # Efficacit√© mesure
        }
        
        for col, range_name in validation_config.items():
            dv = DataValidation(type="list", formula1=f"={range_name}", allow_blank=True)
            ws.add_data_validation(dv)
            dv.add(f"{get_column_letter(col)}2:{get_column_letter(col)}1000")
        
        # Protection et formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"
    
    def _create_atelier5_traitement(self) -> None:
        """Cr√©e l'Atelier 5 - Traitement du risque avec plan d'action d√©taill√©."""
        ws = self.wb.create_sheet("Atelier5_Traitement")
        
        # En-t√™tes fran√ßais selon EBIOS RM Atelier 5
        headers = [
            "ID_Risque", "Sc√©nario_Li√©", "Niveau_Initial", "Option_Traitement", 
            "Mesure_Choisie", "Responsable", "√âch√©ance", "Co√ªt_Estim√©", 
            "Efficacit√©_Attendue", "Niveau_R√©siduel", "Statut_Mise_en_≈íuvre"
        ]
        
        # Cr√©er les en-t√™tes
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # Options de traitement selon EBIOS RM
        options_traitement = ["R√©duire", "√âviter", "Transf√©rer", "Accepter"]
        statuts = ["Planifi√©e", "En cours", "Termin√©e", "Report√©e", "Annul√©e"]
        
        # Validations de donn√©es
        validation_config = {
            3: "Gravite",           # Niveau initial
            4: options_traitement,  # Option traitement  
            5: "Measure_ID",        # Mesure choisie
            6: "Stakeholder_ID",    # Responsable
            8: "Gravite",           # Co√ªt estim√©
            9: "Gravite",           # Efficacit√© attendue
            10: "Gravite",          # Niveau r√©siduel
            11: statuts             # Statut
        }
        
        for col, validation_source in validation_config.items():
            if isinstance(validation_source, list):
                dv = DataValidation(type="list", formula1=f'"{",".join(validation_source)}"', allow_blank=True)
            else:
                dv = DataValidation(type="list", formula1=f"={validation_source}", allow_blank=True)
            ws.add_data_validation(dv)
            dv.add(f"{get_column_letter(col)}2:{get_column_letter(col)}100")
        
        # Formules automatiques pour certaines colonnes
        for row in range(2, 51):
            # Libell√© de la mesure choisie (colonne apr√®s Mesure_Choisie)
            cell = ws.cell(row=row, column=12, value=f"=IFERROR(XLOOKUP(E{row},Measure_ID,tbl_Measure_Label),\"\")")
            self._format_formula_cell(cell)
        
        # Appliquer la protection et le formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"

    def _create_atelier5_mesures(self) -> None:
        """Cr√©e l'Atelier 5 - Catalogue des mesures avec mapping ISO 27001 Annex A."""
        ws = self.wb.create_sheet("Atelier5_Mesures")
        
        # En-t√™tes selon m√©thodo EBIOS RM avec extension ISO
        headers = [
            "Scenario_ID", "Measure_ID", "Libell√©_Mesure", "Categorie", 
            "Cout_Implementation", "Efficacite_pct", "AnnexA_Control", 
            "Statut_Implementation", "Responsable", "Echeance", "Commentaires"
        ]
        
        # Cr√©er les en-t√™tes avec style
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = self.header_font
            cell.fill = self.header_fill
            cell.alignment = Alignment(horizontal="center")
        
        # **INNOVATION** : Validations avec messages d'erreur personnalis√©s
        scenario_dv = DataValidation(type="list", formula1="=Scenario_ID", allow_blank=True)
        scenario_dv.error = "Veuillez choisir un sc√©nario valide dans la liste d√©roulante"
        scenario_dv.errorTitle = "Erreur de saisie - Sc√©nario"
        scenario_dv.prompt = "S√©lectionnez un sc√©nario strat√©gique dans la liste"
        scenario_dv.promptTitle = "Guide de saisie"
        ws.add_data_validation(scenario_dv)
        scenario_dv.add("A2:A1000")
        
        measure_dv = DataValidation(type="list", formula1="=tbl_Measure_ID", allow_blank=True)
        measure_dv.error = "Cette mesure n'existe pas dans le catalogue ISO 27001"
        measure_dv.errorTitle = "Erreur - Mesure inconnue"
        measure_dv.prompt = "Choisissez une mesure du catalogue ISO 27001 Annex A"
        measure_dv.promptTitle = "S√©lection mesure de s√©curit√©"
        ws.add_data_validation(measure_dv)
        measure_dv.add("B2:B1000")
        
        statut_dv = DataValidation(type="list", formula1='"Planifi√©e,En cours,Impl√©ment√©e,Non applicable,Report√©e"', allow_blank=True)
        statut_dv.error = "Statut non reconnu. Utilisez : Planifi√©e, En cours, Impl√©ment√©e, Non applicable ou Report√©e"
        statut_dv.errorTitle = "Statut invalide"
        statut_dv.prompt = "Indiquez l'√©tat d'avancement de la mesure"
        ws.add_data_validation(statut_dv)
        statut_dv.add("H2:H1000")
        
        # **INNOVATION** : Formules XLOOKUP pour remplissage automatique des m√©tadonn√©es
        for row in range(2, 201):
            # Libell√© automatique depuis catalogue
            cell = ws.cell(row=row, column=3, value=f"=IFERROR(XLOOKUP(B{row},tbl_Measure_ID,tbl_Measure_Label),\"\")")
            self._format_formula_cell(cell)
            
            # Cat√©gorie automatique
            cell = ws.cell(row=row, column=4, value=f"=IFERROR(XLOOKUP(B{row},tbl_Measure_ID,tbl_Measure_Category),\"\")")
            self._format_formula_cell(cell)
            
            # Co√ªt d'impl√©mentation
            cell = ws.cell(row=row, column=5, value=f"=IFERROR(XLOOKUP(B{row},tbl_Measure_ID,tbl_Measure_Cout),\"\")")
            self._format_formula_cell(cell)
            
            # Efficacit√© par d√©faut
            cell = ws.cell(row=row, column=6, value=f"=IFERROR(XLOOKUP(B{row},tbl_Measure_ID,tbl_Measure_Efficacite),\"\")")
            self._format_formula_cell(cell)
            
            # Contr√¥le Annex A
            cell = ws.cell(row=row, column=7, value=f"=IFERROR(XLOOKUP(B{row},tbl_Measure_ID,tbl_Measure_AnnexA),\"\")")
            self._format_formula_cell(cell)
        
        # Protection et formatage
        self._apply_sheet_protection(ws)
        ws.freeze_panes = "B2"

    def _create_heatmap_visualization(self) -> None:
        """Cr√©e l'onglet Heat-map avec matrice de risque visuelle."""
        ws = self.wb.create_sheet("HeatMap_Risques")
        
        # Titre principal
        ws.merge_cells("A1:J1")
        title = ws["A1"]
        title.value = "üî• MATRICE DE CHALEUR - CARTOGRAPHIE DES RISQUES"
        title.font = Font(size=16, bold=True, color="FFFFFF")
        title.fill = PatternFill(start_color="C0392B", end_color="C0392B", fill_type="solid")
        title.alignment = Alignment(horizontal="center", vertical="center")
        
        # **INNOVATION** : Matrice 4√ó4 avec mise en forme conditionnelle
        # Headers Vraisemblance (colonnes)
        likelihood_labels = ["", "Minimal", "Significatif", "√âlev√©", "Maximal"]
        for col, label in enumerate(likelihood_labels, 2):
            cell = ws.cell(row=3, column=col, value=label)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="2C3E50", end_color="2C3E50", fill_type="solid")
            cell.alignment = Alignment(horizontal="center")
        
        # Headers Gravit√© (lignes) 
        gravity_labels = ["N√©gligeable", "Limit√©", "Important", "Critique"]
        risk_matrix_values = [
            [1, 2, 3, 4],      # N√©gligeable
            [2, 4, 6, 8],      # Limit√©  
            [3, 6, 9, 12],     # Important
            [4, 8, 12, 16]     # Critique
        ]
        
        risk_colors = {
            (1, 2, 3): "27AE60",     # Vert - Faible
            (4, 6): "F39C12",        # Orange - Moyen  
            (8, 9): "E74C3C",        # Rouge - √âlev√©
            (12, 16): "C0392B"       # Rouge fonc√© - Critique
        }
        
        for row_idx, (gravity_label, risk_row) in enumerate(zip(gravity_labels, risk_matrix_values), 4):
            # Label gravit√©
            gravity_cell = ws.cell(row=row_idx, column=1, value=gravity_label)
            gravity_cell.font = Font(bold=True, color="FFFFFF")
            gravity_cell.fill = PatternFill(start_color="2C3E50", end_color="2C3E50", fill_type="solid")
            gravity_cell.alignment = Alignment(horizontal="center")
            
            # Valeurs de risque avec couleurs
            for col_idx, risk_value in enumerate(risk_row, 2):
                risk_cell = ws.cell(row=row_idx, column=col_idx, value=risk_value)
                risk_cell.alignment = Alignment(horizontal="center", vertical="center")
                risk_cell.font = Font(bold=True, size=14, color="FFFFFF")
                
                # Appliquer couleur selon valeur
                for values, color in risk_colors.items():
                    if risk_value in values:
                        risk_cell.fill = PatternFill(start_color=color, end_color=color, fill_type="solid")
                        break
        
        # **INNOVATION** : Tableau de r√©partition dynamique des sc√©narios
        ws["A10"] = "üìä R√âPARTITION DES SC√âNARIOS PAR ZONE DE RISQUE"
        ws["A10"].font = Font(size=12, bold=True)
        
        distribution_headers = ["Zone de Risque", "Nombre Sc√©narios", "% Total", "Actions Recommand√©es"]
        for col, header in enumerate(distribution_headers, 1):
            cell = ws.cell(row=11, column=col, value=header)
            cell.font = Font(bold=True)
            cell.fill = PatternFill(start_color="BDC3C7", end_color="BDC3C7", fill_type="solid")
        
        zones_risk = [
            ("üü¢ Acceptable (1-3)", '=COUNTIFS(Atelier4_Operationnels[Risque_Residuel],">=1",Atelier4_Operationnels[Risque_Residuel],"<=3")', "Surveillance"),
            ("üü° Tol√©rable (4-6)", '=COUNTIFS(Atelier4_Operationnels[Risque_Residuel],">=4",Atelier4_Operationnels[Risque_Residuel],"<=6")', "Mesures cibl√©es"),
            ("üü† Inacceptable (8-9)", '=COUNTIFS(Atelier4_Operationnels[Risque_Residuel],">=8",Atelier4_Operationnels[Risque_Residuel],"<=9")', "Plan d'action imm√©diat"),
            ("üî¥ Critique (12-16)", '=COUNTIFS(Atelier4_Operationnels[Risque_Residuel],">=12",Atelier4_Operationnels[Risque_Residuel],"<=16")', "Traitement d'urgence")
        ]
        
        for row_idx, (zone, formula, action) in enumerate(zones_risk, 12):
            ws.cell(row=row_idx, column=1, value=zone)
            ws.cell(row=row_idx, column=2, value=formula)
            ws.cell(row=row_idx, column=3, value=f'=IF(SUM(B12:B15)>0,B{row_idx}/SUM(B12:B15)*100,0)&"%"')
            ws.cell(row=row_idx, column=4, value=action)

    def _create_kpi_dashboard(self) -> None:
        """Cr√©e l'onglet KPI avec indicateurs Velocity et Preparedness."""
        ws = self.wb.create_sheet("KPI_Dashboard")
        
        # Titre dashboard
        ws.merge_cells("A1:H1")
        title = ws["A1"]
        title.value = "üìà TABLEAU DE BORD - INDICATEURS EBIOS RM"
        title.font = Font(size=16, bold=True, color="FFFFFF")
        title.fill = PatternFill(start_color="8E44AD", end_color="8E44AD", fill_type="solid")
        title.alignment = Alignment(horizontal="center")
        
        # **SECTION VELOCITY** : Rapidit√© de d√©tection et r√©ponse
        ws["A3"] = "‚ö° VELOCITY - Rapidit√© d'intervention"
        ws["A3"].font = Font(size=14, bold=True, color="2C3E50")
        
        velocity_headers = ["Indicateur", "Valeur Actuelle", "Cible", "Statut", "Tendance"]
        for col, header in enumerate(velocity_headers, 1):
            cell = ws.cell(row=4, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="3498DB", end_color="3498DB", fill_type="solid")
        
        velocity_kpis = [
            ("Temps d√©tection incident (h)", "=AVERAGE(Incidents[Temps_Detection])", "24", '=IF(B5<=C5,"‚úÖ Conforme","‚ö†Ô∏è √Ä am√©liorer")'),
            ("Temps r√©ponse incident (h)", "=AVERAGE(Incidents[Temps_Reponse])", "4", '=IF(B6<=C6,"‚úÖ Conforme","‚ùå Non conforme")'),
            ("% incidents r√©solus < 72h", "=COUNTIFS(Incidents[Temps_Resolution],'<72')/COUNT(Incidents[ID])*100", "90", '=IF(B7>=C7,"‚úÖ Conforme","‚ö†Ô∏è √Ä am√©liorer")')
        ]
        
        for row_idx, (kpi_name, formula, target, status_formula) in enumerate(velocity_kpis, 5):
            ws.cell(row=row_idx, column=1, value=kpi_name)
            ws.cell(row=row_idx, column=2, value=formula)
            ws.cell(row=row_idx, column=3, value=target)
            ws.cell(row=row_idx, column=4, value=status_formula)
            ws.cell(row=row_idx, column=5, value="üìä")  # Placeholder pour graphique sparkline
        
        # **SECTION PREPAREDNESS** : Niveau de pr√©paration
        ws["A10"] = "üõ°Ô∏è PREPAREDNESS - Niveau de pr√©paration"
        ws["A10"].font = Font(size=14, bold=True, color="2C3E50")
        
        for col, header in enumerate(velocity_headers, 1):
            cell = ws.cell(row=11, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="27AE60", end_color="27AE60", fill_type="solid")
        
        preparedness_kpis = [
            ("% actifs couverts mesures", "=COUNTIFS(Atelier1_Socle[Score_Risque],'>0')/COUNT(Atelier1_Socle[ID_Actif])*100", "95", '=IF(B12>=C12,"‚úÖ Conforme","‚ö†Ô∏è Exposition")'),
            ("% personnel form√© SSI", "=COUNTIFS(Personnel[Formation_SSI],'Oui')/COUNT(Personnel[ID])*100", "90", '=IF(B13>=C13,"‚úÖ Conforme","‚ùå Formation requise")'),
            ("Maturit√© globale (1-5)", "=AVERAGE(Maturite[Score_Domaine])", "3", '=IF(B14>=C14,"‚úÖ Mature","‚ö†Ô∏è Am√©lioration")'),
            ("% mesures impl√©ment√©es", "=COUNTIFS(Atelier5_Mesures[Statut_Implementation],'Impl√©ment√©e')/COUNT(Atelier5_Mesures[Measure_ID])*100", "80", '=IF(B15>=C15,"‚úÖ Conforme","‚ùå Retard")')
        ]
        
        for row_idx, (kpi_name, formula, target, status_formula) in enumerate(preparedness_kpis, 12):
            ws.cell(row=row_idx, column=1, value=kpi_name)
            ws.cell(row=row_idx, column=2, value=formula)
            ws.cell(row=row_idx, column=3, value=target)
            ws.cell(row=row_idx, column=4, value=status_formula)
            ws.cell(row=row_idx, column=5, value="üìà")
        
        # **SECTION SYNTH√àSE** : Vue globale
        ws["A18"] = "üéØ SYNTH√àSE GLOBALE"
        ws["A18"].font = Font(size=14, bold=True, color="2C3E50")
        
        synthesis_formulas = [
            ("Score Global Velocity", "=AVERAGE(B5:B7)"),
            ("Score Global Preparedness", "=AVERAGE(B12:B15)"),
            ("Index Maturit√© EBIOS", "=(F19+F20)/2"),
            ("Recommandation Prioritaire", '=IF(F21<2.5,"Formation & Outils","Optimisation Continue")')
        ]
        
        for row_idx, (metric, formula) in enumerate(synthesis_formulas, 19):
            ws.cell(row=row_idx, column=1, value=metric).font = Font(bold=True)
            ws.cell(row=row_idx, column=2, value=formula)

def main():
    """Point d'entr√©e principal pour la g√©n√©ration du template EBIOS RM."""
    # Configuration du logging pour avoir des messages visibles
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[
            logging.StreamHandler(),  # Affichage console
        ]
    )
    
    print("üöÄ D√©marrage du g√©n√©rateur EBIOS RM...")
    print("=" * 60)
    
    # Initialiser le g√©n√©rateur
    print("üîß Initialisation du g√©n√©rateur...")
    generator = EBIOSTemplateGenerator()
    
    # D√©finir le chemin de sortie
    output_path = Path("c:/Users/mushm/Documents/AR/templates/ebios_risk_assessment_FR.xlsx")
    
    print(f"üìÅ Cr√©ation du r√©pertoire de sortie...")
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    print(f"üìä G√©n√©ration du template EBIOS RM...")
    print(f"   Destination: {output_path}")
    
    try:
        # G√©n√©rer le template complet
        generator.generate_template(output_path)
        
        print("\n" + "=" * 60)
        print("‚úÖ SUCC√àS : Template EBIOS RM g√©n√©r√© avec succ√®s!")
        print("=" * 60)
        print(f"üìÅ Fichier cr√©√© : {output_path}")
        print(f"üìä Taille du fichier : {output_path.stat().st_size / 1024:.1f} KB")
        
        # V√©rifier la structure cr√©√©e
        try:
            from openpyxl import load_workbook
            wb = load_workbook(output_path)
            sheet_names = wb.sheetnames
            print(f"üìã Onglets cr√©√©s ({len(sheet_names)}) :")
            for i, sheet in enumerate(sheet_names, 1):
                print(f"   {i}. {sheet}")
            wb.close()
        except Exception as e:
            print(f"‚ö†Ô∏è  Impossible de v√©rifier la structure : {e}")
        
        print("\nüéØ Le template est pr√™t pour utilisation!")
        print("   Vous pouvez maintenant ex√©cuter 'python visualize_template.py'")
        
    except Exception as e:
        print("\n" + "=" * 60)
        print("‚ùå ERREUR lors de la g√©n√©ration du template")
        print("=" * 60)
        print(f"üí• Erreur : {e}")
        logging.exception("Erreur d√©taill√©e")
        print("\nüí° Suggestions de r√©solution :")
        print("   ‚Ä¢ V√©rifiez que vous avez les droits d'√©criture")
        print("   ‚Ä¢ Fermez Excel s'il est ouvert")
        print("   ‚Ä¢ V√©rifiez l'espace disque disponible")
        return False
    
    return True

if __name__ == "__main__":
    success = main()
    if not success:
        exit(1)